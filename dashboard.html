<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SSBS Portal â€“ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">

  <!-- Brand + Theme tokens -->
  <style>
    :root{ --brand:#F4393A; --brand-accent:#FF7B79; --brand-dark:#C12D2E;
           --grad:linear-gradient(135deg,var(--brand),var(--brand-accent)); }
    body{ background:var(--bg); color:var(--ink); }
    body:not(.light){ --bg:#0f172a; --panel:#111827; --panel2:#0b1220; --ink:#e5e7eb; --muted:#94a3b8; --line:#1f2937; }
    body.light{ --bg:#f8fafc; --panel:#ffffff; --panel2:#f1f5f9; --ink:#0f172a; --muted:#475569; --line:#e2e8f0; }
    .panel{ background:var(--panel); border-color:var(--line); }
    .panel2{ background:var(--panel2); border-color:var(--line); }
    .muted{ color:var(--muted); }
    .brand-grad{ background:var(--grad); }
    .nav-btn.active{ background:var(--grad); color:#fff; border-color:transparent; }
    .nav-btn{ transition:opacity .2s ease; }
    .thin-scroll::-webkit-scrollbar{ width:8px } .thin-scroll::-webkit-scrollbar-thumb{ background:#0003; border-radius:999px }
    body.light .thin-scroll::-webkit-scrollbar-thumb{ background:#0005 }

    /* iframe swipe/transition */
    #frameWrap{ position:relative; overflow:hidden; }
    #appFrame{ width:100%; height:calc(100vh - 64px); border:0; transition:transform .25s ease, opacity .25s ease; }
    .slide-hint-left  { transform:translateX(-24px); opacity:.85; }
    .slide-hint-right { transform:translateX( 24px); opacity:.85; }
  </style>
</head>
<body>
  <div class="min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-72 hidden md:flex flex-col border-r panel">
      <div class="p-4 border-b" style="border-color:var(--line)">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg brand-grad text-white font-extrabold grid place-items-center shadow">SS</div>
          <div>
            <div class="text-lg font-extrabold">SSBS</div>
            <div class="text-xs uppercase tracking-wide muted">Business Portal</div>
          </div>
        </div>
        <div class="mt-3 text-sm"><span class="muted">Signed in as</span> <b id="hiUser">â€”</b></div>
      </div>

      <nav id="sideNav" class="flex-1 overflow-y-auto thin-scroll p-3 space-y-1">
        <button data-mod="dashboard" class="nav-btn w-full text-left px-3 py-2 rounded-lg panel2 border">ğŸ  Dashboard</button>

        <div class="mt-3 text-xs uppercase tracking-wider muted px-2">Operations</div>
        <button data-mod="daily" class="nav-btn w-full text-left px-3 py-2 rounded-lg panel2 border">ğŸ“… Daily Application</button>
        <button data-mod="expense" class="nav-btn w-full text-left px-3 py-2 rounded-lg panel2 border">ğŸ’° Expense Management</button>
        <button data-mod="receive" class="nav-btn w-full text-left px-3 py-2 rounded-lg panel2 border">ğŸ’µ Receiving Payments</button>
        <button data-mod="transfer" class="nav-btn w-full text-left px-3 py-2 rounded-lg panel2 border">ğŸ”„ Internal Transfer & Loan</button>

        <div class="mt-3 text-xs uppercase tracking-wider muted px-2">Billing</div>
        <button data-mod="invoice" class="nav-btn w-full text-left px-3 py-2 rounded-lg panel2 border">ğŸ§¾ Invoice Management</button>
        <button data-mod="invoice_d" class="nav-btn w-full text-left px-3 py-2 rounded-lg panel2 border">ğŸ“‘ Dummy Invoice</button>
        <button data-mod="quote" class="nav-btn w-full text-left px-3 py-2 rounded-lg panel2 border">ğŸ’¬ Quotation</button>
        <button data-mod="statement" class="nav-btn w-full text-left px-3 py-2 rounded-lg panel2 border">ğŸ“Š Client Statement</button>

        <div class="mt-3 text-xs uppercase tracking-wider muted px-2">Records</div>
        <button data-mod="docs" class="nav-btn w-full text-left px-3 py-2 rounded-lg panel2 border">ğŸ“‚ Document Management</button>
        <button data-mod="client" class="nav-btn w-full text-left px-3 py-2 rounded-lg panel2 border">ğŸ‘¥ Client Management</button>

        <div class="mt-3 text-xs uppercase tracking-wider muted px-2">Team</div>
        <button data-mod="task" class="nav-btn w-full text-left px-3 py-2 rounded-lg panel2 border">âœ… Task Management</button>
        <button data-mod="mcp" class="nav-btn w-full text-left px-3 py-2 rounded-lg panel2 border">âš™ï¸ Master Control Panel</button>
      </nav>

      <div class="p-3 border-t" style="border-color:var(--line)">
        <div class="flex gap-2">
          <button id="themeBtn" class="flex-1 px-3 py-2 rounded-lg border panel2">â˜€ï¸ Light</button>
          <button id="btn_logout" class="flex-1 px-3 py-2 rounded-lg text-white brand-grad">Logout</button>
        </div>
      </div>
    </aside>

    <!-- Mobile header -->
    <header class="md:hidden w-full panel border-b">
      <div class="px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-lg brand-grad text-white font-extrabold grid place-items-center">SS</div>
          <div>
            <div class="font-extrabold">SSBS</div>
            <div class="text-xs muted -mt-0.5">Business Portal</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="themeBtnMobile" class="px-3 py-1 rounded-lg border panel2">â˜€ï¸ Light</button>
          <button id="btn_logout_m" class="px-3 py-1 rounded-lg text-white brand-grad">Logout</button>
          <button id="menuToggle" class="px-3 py-1 rounded-lg border panel2">â˜°</button>
        </div>
      </div>
      <div id="mobileMenu" class="hidden px-3 pb-3 space-y-1">
        <div class="px-2 text-xs uppercase tracking-wider muted">Hello, <b id="hiUser_m">â€”</b></div>
        <div id="mobileNav" class="grid grid-cols-2 gap-2">
          <!-- buttons cloned here from sidebar -->
        </div>
      </div>
    </header>

    <!-- Main content -->
    <main class="flex-1">
      <div class="hidden md:flex items-center justify-between px-6 py-4 border-b panel">
        <div class="flex items-center gap-2">
          <h1 id="pageTitle" class="text-xl font-bold">Dashboard</h1>
          <span class="muted">â€¢ inside view</span>
        </div>
        <div class="text-sm">Welcome,&nbsp;<b id="hiUser_top">â€”</b></div>
      </div>

      <!-- Welcome cards (shown until a module is opened) -->
      <div id="welcome" class="p-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        <button data-mod="daily" class="px-5 py-4 rounded-xl border panel hover:opacity-95 text-left">
          <div class="text-2xl">ğŸ“…</div><div class="mt-2 font-semibold">Daily Application</div>
          <div class="text-sm muted">Enter new application, charges, portal, clientsâ€¦</div>
        </button>
        <button data-mod="invoice" class="px-5 py-4 rounded-xl border panel hover:opacity-95 text-left">
          <div class="text-2xl">ğŸ§¾</div><div class="mt-2 font-semibold">Invoice Management</div>
          <div class="text-sm muted">Create, view, or print invoices</div>
        </button>
        <button data-mod="client" class="px-5 py-4 rounded-xl border panel hover:opacity-95 text-left">
          <div class="text-2xl">ğŸ‘¥</div><div class="mt-2 font-semibold">Client Management</div>
          <div class="text-sm muted">Add, edit, or search clients</div>
        </button>
      </div>

      <!-- Embedded module -->
      <div id="frameWrap" class="hidden">
        <iframe id="appFrame" title="SSBS Module"></iframe>
      </div>
    </main>
  </div>

  <!-- Router -->
  <script src="app.js"></script>

  <!-- Page wiring -->
  <script>
    // Theme boot
    (function(){
      const saved = localStorage.getItem('ssbs_theme') || 'dark';
      if(saved === 'light') document.body.classList.add('light');
      function setLabel(btn){ if(!btn) return; const isLight = document.body.classList.contains('light'); btn.textContent = isLight ? 'ğŸŒ™ Dark' : 'â˜€ï¸ Light'; }
      const btnD = document.getElementById('themeBtn');
      const btnM = document.getElementById('themeBtnMobile');
      function toggle(){ document.body.classList.toggle('light'); localStorage.setItem('ssbs_theme', document.body.classList.contains('light') ? 'light' : 'dark'); setLabel(btnD); setLabel(btnM); }
      if(btnD){ btnD.onclick = toggle; setLabel(btnD); }
      if(btnM){ btnM.onclick = toggle; setLabel(btnM); }
    })();

    // Session boot
    (function(){
      const u = SSBS.currentUser();
      if(!u){ location.href='index.html'; return; }
      ['hiUser','hiUser_top','hiUser_m'].forEach(id => { const el = document.getElementById(id); if(el) el.textContent = u.name; });
      ['click','keydown','touchstart'].forEach(evt => document.addEventListener(evt, () => SSBS.touch(), { passive:true }));
    })();

    // Clone sidebar buttons into mobile grid
    (function cloneMobile(){
      const m = document.getElementById('mobileNav');
      const s = document.getElementById('sideNav');
      if(!m || !s) return;
      s.querySelectorAll('[data-mod]').forEach(btn=>{
        const b = document.createElement('button');
        b.className = 'px-3 py-2 rounded-lg panel2 border';
        b.textContent = btn.textContent;
        b.setAttribute('data-mod', btn.getAttribute('data-mod'));
        m.appendChild(b);
      });
    })();

    // Mobile menu toggle
    (function(){
      const tog = document.getElementById('menuToggle');
      const menu = document.getElementById('mobileMenu');
      if(tog && menu){ tog.onclick = () => menu.classList.toggle('hidden'); }
    })();

    // Logout
    (function(){
      const doLogout = () => { SSBS.logout(); location.href='index.html'; };
      const loD = document.getElementById('btn_logout');
      const loM = document.getElementById('btn_logout_m');
      if(loD) loD.onclick = doLogout;
      if(loM) loM.onclick = doLogout;
    })();

    // ===== Inside view + swipe =====
    (function(){
      const frame = document.getElementById('appFrame');
      const wrap  = document.getElementById('frameWrap');
      const welcome = document.getElementById('welcome');
      const pageTitle = document.getElementById('pageTitle');

      // Ordered list of modules for swipe
      const order = Array.from(document.querySelectorAll('#sideNav [data-mod]')).map(b=>b.dataset.mod);
      let current = null;

      function setActive(key){
        document.querySelectorAll('[data-mod]').forEach(b => b.classList.toggle('active', b.dataset.mod===key));
        pageTitle && (pageTitle.textContent = (document.querySelector(`[data-mod="${key}"]`)?.textContent || 'Dashboard').trim());
      }

      function openInPortal(key, hint){ // hint: 'left' or 'right' for tiny motion
        const url = SSBS.link(key);
        if(!url){ alert('Module not configured.'); return; }
        localStorage.setItem('ssbs_last_mod', key);

        welcome.classList.add('hidden');
        wrap.classList.remove('hidden');

        // tiny motion
        if(hint==='left')  frame.classList.add('slide-hint-left');
        if(hint==='right') frame.classList.add('slide-hint-right');

        let loaded = false;
        frame.onload = () => {
          loaded = true;
          frame.classList.remove('slide-hint-left','slide-hint-right');
        };
        frame.src = url;
        current = key;

        setActive(key);

        // Fallback if iframe blocked
        setTimeout(()=>{ if(!loaded){ window.open(url, '_blank', 'noopener,noreferrer'); }}, 1500);
      }

      // Click to open (sidebar + mobile + welcome cards)
      function bindClicks(root){ root.querySelectorAll('[data-mod]').forEach(btn => btn.addEventListener('click',()=> openInPortal(btn.dataset.mod))); }
      bindClicks(document);

      // Restore last opened
      const last = localStorage.getItem('ssbs_last_mod');
      if(last){ openInPortal(last); }

      // Swipe detection on the frame area
      let startX=0,startY=0,tracking=false;
      function idxOf(k){ return order.indexOf(k); }
      function neighbor(dir){
        if(!current) return null;
        const i = idxOf(current);
        if(i<0) return null;
        const j = i + (dir==='next'?1:-1);
        if(j<0 || j>=order.length) return null; // clamp; remove to loop
        return order[j];
      }
      wrap.addEventListener('pointerdown', e => { tracking=true; startX=e.clientX; startY=e.clientY; });
      wrap.addEventListener('pointerup',   e => {
        if(!tracking) return; tracking=false;
        const dx = e.clientX - startX, dy = e.clientY - startY;
        if(Math.abs(dx) > 70 && Math.abs(dx) > Math.abs(dy)){
          if(dx < 0){ const n = neighbor('next'); if(n) openInPortal(n,'left'); }
          if(dx > 0){ const p = neighbor('prev'); if(p) openInPortal(p,'right'); }
        }
      });
      // Prevent iframe from stealing gestures immediately
      wrap.addEventListener('pointermove', e => {
        if(!tracking) return;
        const dx = Math.abs(e.clientX - startX), dy = Math.abs(e.clientY - startY);
        if(dx > dy) e.preventDefault();
      }, { passive:false });

      // Public (optional): allow other scripts to open inside
      window.SSBS_OPEN_INSIDE = openInPortal;
    })();
  </script>
</body>
</html>
